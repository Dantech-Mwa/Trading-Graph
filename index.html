<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Elite Live Crypto & NFT Dashboard</title>

  <!-- Chart.js + adapters -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.3/dist/confetti.browser.min.js"></script>

  <style>
    /* ────────────────────── DARK THEME (default) ────────────────────── */
    :root[data-theme="dark"] {
      --bg: #0f0f1a;
      --card: rgba(20, 20, 40, 0.7);
      --glass: rgba(255, 255, 255, 0.05);
      --text: #e0e0ff;
      --green: #00ff88;
      --red: #ff3b5c;
      --accent: #00d4ff;
      --gold: #ffd700;
      --purple: #aa00ff;
      --orange: #ff8800;
      --shadow: 0 8px 32px rgba(0,0,0,0.4);
      --grid: rgba(255,255,255,0.1);
      --border: rgba(255,255,255,0.1);
    }

    /* ────────────────────── LIGHT THEME ────────────────────── */
    :root[data-theme="light"] {
      --bg: #f8f9fa;
      --card: rgba(255, 255, 255, 0.85);
      --glass: rgba(0, 0, 0, 0.03);
      --text: #212529;
      --green: #28a745;
      --red: #dc3545;
      --accent: #007bff;
      --gold: #ffc107;
      --purple: #6f42c1;
      --orange: #fd7e14;
      --shadow: 0 8px 32px rgba(0,0,0,0.12);
      --grid: rgba(0,0,0,0.1);
      --border: rgba(0,0,0,0.1);
    }

    * { margin:0; padding:0; box-sizing:border-box; }
    body {
      background: var(--bg);
      color: var(--text);
      font-family: 'Inter','Segoe UI',sans-serif;
      padding:12px;
      transition: background .3s, color .3s;
      min-height:100vh;
      background: linear-gradient(135deg,
        var(--bg) 0%,
        color-mix(in srgb, var(--bg) 80%, #111) 100%);
    }
    .container { max-width:1400px; margin:0 auto; }

    /* Header */
    .header{
      text-align:center; margin-bottom:16px;
      backdrop-filter:blur(10px); background:var(--glass);
      border-radius:16px; padding:12px;
      border:1px solid var(--border);
    }
    h1{
      font-size:clamp(1.4rem,5vw,2rem); font-weight:800;
      background:linear-gradient(90deg,var(--green),var(--accent));
      -webkit-background-clip:text; -webkit-text-fill-color:transparent;
      margin-bottom:4px;
    }
    .ticker{
      font-size:clamp(1.6rem,6vw,2.4rem); font-weight:900;
      letter-spacing:1px; text-shadow:0 0 20px rgba(0,212,170,.5);
      animation:pulse 2s infinite;
    }
    @keyframes pulse{0%,100%{opacity:1}50%{opacity:.8}}

    .status{font-size:.9rem;color:var(--accent);font-weight:500}
    .trading-buttons{display:flex;justify-content:center;gap:12px;margin:12px 0}
    .btn{
      padding:10px 20px; border:none; border-radius:12px;
      font-weight:bold; cursor:pointer; transition:var(--transition);
      box-shadow:var(--shadow);
    }
    .btn-buy{background:var(--green);color:#fff}
    .btn-sell{background:var(--red);color:#fff}
    .btn:hover{transform:scale(1.05);box-shadow:0 0 20px currentColor}

    .chart-box{
      background:var(--card); border-radius:20px; padding:16px;
      margin-bottom:16px; box-shadow:var(--shadow);
      backdrop-filter:blur(12px); border:1px solid var(--border);
      position:relative; overflow:hidden;
    }
    .chart-box::before{
      content:''; position:absolute; top:0; left:0; right:0; height:3px;
      background:linear-gradient(90deg,var(--green),var(--accent),var(--purple));
    }
    #tradingview-chart{width:100%;height:400px;border-radius:12px}

    .marquee{
      background:var(--glass); padding:12px; border-radius:16px;
      overflow:hidden; white-space:nowrap; font-size:.95rem;
      margin:16px 0; border:1px solid var(--border);
    }
    .marquee-content{display:inline-block;animation:scroll 30s linear infinite}
    @keyframes scroll{0%{transform:translateX(0)}100%{transform:translateX(-50%)}}
    .asset-item{display:inline-block;margin-right:32px;font-weight:600}
    .asset-name{color:var(--gold)}
    .asset-price{color:var(--text)}
    .asset-change{font-size:.8rem}
    .nft-item{color:var(--purple)}

    .wallet-btn,.theme-toggle{
      position:fixed; top:20px; padding:8px 16px;
      background:var(--accent); color:#fff; border:none;
      border-radius:8px; cursor:pointer; transition:all .3s;
      font-weight:600; z-index:100;
    }
    .wallet-btn{right:20px}
    .theme-toggle{right:140px}
    .wallet-btn:hover,.theme-toggle:hover{background:var(--purple)}

    .modal{display:none;position:fixed;z-index:1000;left:0;top:0;width:100%;height:100%;
      background:rgba(0,0,0,.5);backdrop-filter:blur(5px)}
    .modal-content{
      background:var(--card); margin:15% auto; padding:30px;
      border-radius:16px; width:80%; max-width:450px; text-align:center;
      box-shadow:var(--shadow);
    }
    .close{color:#aaa;float:right;font-size:28px;font-weight:bold;cursor:pointer}
    .close:hover{color:var(--text)}

    .footer{
      text-align:center; margin:24px 0 12px; font-size:.8rem;
      color:#888; font-style:italic;
    }
    .loading-spinner{
      display:inline-block; width:20px; height:20px;
      border:3px solid rgba(255,255,255,.3); border-radius:50%;
      border-top-color:var(--accent); animation:spin 1s ease-in-out infinite;
      margin-right:10px;
    }
    @keyframes spin{to{transform:rotate(360deg)}}

    .binance-link{
      display:inline-block; margin-top:15px; padding:12px 24px;
      background:var(--accent); color:#fff; text-decoration:none;
      border-radius:8px; font-weight:bold; transition:all .3s;
    }
    .binance-link:hover{background:var(--orange);transform:translateY(-2px)}

    .chart-container{height:300px;position:relative}

    @media(max-width:768px){
      .chart-box{padding:12px;margin-bottom:12px}
      #tradingview-chart{height:300px}
      .trading-buttons{flex-direction:column;align-items:center}
      .marquee{font-size:.85rem}
      .asset-item{margin-right:20px}
      .theme-toggle{right:20px;top:70px}
      .wallet-btn{right:20px;top:20px}
    }
  </style>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800;900&display=swap" rel="stylesheet">
</head>

<body>
  <!-- Theme toggle -->
  <button class="theme-toggle" id="themeToggle" aria-label="Toggle dark / light theme">
    Dark/Light
  </button>

  <button class="wallet-btn" onclick="connectWallet()">Connect Wallet</button>

  <div class="container">
    <div class="header">
      <h1>Elite Live Crypto & NFT Dashboard</h1>
      <div class="ticker" id="livePrice">Loading...</div>
      <div class="status" id="status">
        <span class="loading-spinner"></span>Connecting to Binance WebSocket...
      </div>
      <div class="trading-buttons">
        <button class="btn btn-buy" onclick="executeTrade('buy')">Buy BNB</button>
        <button class="btn btn-sell" onclick="executeTrade('sell')">Sell BNB</button>
      </div>
    </div>

    <div class="chart-box"><div id="tradingview-chart"></div></div>

    <div class="chart-box">
      <div class="chart-container"><canvas id="volumeChart"></canvas></div>
    </div>

    <div class="chart-box">
      <div class="chart-container"><canvas id="rsiChart"></canvas></div>
    </div>

    <div class="chart-box">
      <div class="chart-container"><canvas id="macdChart"></canvas></div>
    </div>

    <div class="marquee"><div class="marquee-content" id="tickerTape"></div></div>

    <div class="footer">
      Live Binance WebSocket Data • Real-time Trading • Professional Indicators
    </div>
  </div>

  <div id="tradeModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeModal()">x</span>
      <h2 id="modalTitle">Trade Redirect</h2>
      <p id="modalMessage">You are being redirected to Binance to execute your trade.</p>
      <a id="binanceTradeLink" class="binance-link" href="#" target="_blank">
        Continue to Binance
      </a>
    </div>
  </div>

  <script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>
  <script>
    /* ──────────────────────────────────────────────────────────────
       THEME TOGGLE
       ────────────────────────────────────────────────────────────── */
    const html = document.documentElement;
    const toggleBtn = document.getElementById('themeToggle');

    function setTheme(theme) {
      html.dataset.theme = theme;
      localStorage.setItem('theme', theme);
      toggleBtn.textContent = theme === 'dark' ? 'Light' : 'Dark';
    }

    // Init
    const saved = localStorage.getItem('theme') || 'dark';
    setTheme(saved);

    toggleBtn.addEventListener('click', () => {
      const newTheme = html.dataset.theme === 'dark' ? 'light' : 'dark';
      setTheme(newTheme);
    });

    /* ──────────────────────────────────────────────────────────────
       REST OF YOUR ORIGINAL CODE (MACD fixed, etc.)
       ────────────────────────────────────────────────────────────── */
    const SYMBOL = 'BNBUSDT';
    const BINANCE_TRADE_URL = `https://www.binance.com/en/trade/${SYMBOL}`;
    let binanceSocket = null;
    let chartData = [], volumeData = [], lastPrice = 0;
    let volumeChart, rsiChart, macdChart;

    // TradingView
    function initTradingView() {
      new TradingView.widget({
        width: "100%", height: "400", symbol: `BINANCE:${SYMBOL}`,
        interval: "1", timezone: "Etc/UTC", theme: html.dataset.theme,
        style: "1", locale: "en", toolbar_bg: "#f1f3f6",
        enable_publishing: false, hide_side_toolbar: false,
        allow_symbol_change: true, container_id: "tradingview-chart",
        studies: ["Volume@tv-basicstudies","RSI@tv-basicstudies","MACD@tv-basicstudies"]
      });
    }

    // Chart.js init
    function initCharts() {
      const grid = 'var(--grid)', text = 'var(--text)';

      // Volume
      volumeChart = new Chart(document.getElementById('volumeChart'), {
        type:'bar', data:{datasets:[{
          label:'Volume', data:[],
          backgroundColor: ctx => {
            const i = ctx.dataIndex;
            if (i>0 && chartData[i] && chartData[i-1])
              return chartData[i].c >= chartData[i-1].c ?
                'rgba(0,255,136,.7)' : 'rgba(255,59,92,.7)';
            return 'rgba(0,212,255,.7)';
          },
          borderColor:'rgba(255,255,255,.3)', borderWidth:1, borderRadius:2
        }]},
        options:{responsive:true,maintainAspectRatio:false,
          plugins:{legend:{display:false},title:{display:true,text:'TRADING VOLUME',
            color:text,font:{size:14,weight:'bold'}}},
          scales:{x:{type:'time',time:{unit:'minute'},grid:{color:grid},ticks:{color:text}},
                  y:{beginAtZero:true,grid:{color:grid},ticks:{color:text},
                     title:{display:true,text:'Volume',color:text}}}
        }
      });

      // RSI
      rsiChart = new Chart(document.getElementById('rsiChart'), {
        type:'line', data:{datasets:[{
          label:'RSI', data:[], borderColor:'#aa00ff',
          backgroundColor:'rgba(170,0,255,.1)', fill:true,
          tension:.4, pointRadius:0, borderWidth:2
        }]},
        options:{responsive:true,maintainAspectRatio:false,
          plugins:{legend:{display:false},title:{display:true,text:'RELATIVE STRENGTH INDEX (RSI)',
            color:text,font:{size:14,weight:'bold'}}},
          scales:{x:{type:'time',time:{unit:'minute'},grid:{color:grid},ticks:{color:text}},
                  y:{min:0,max:100,grid:{color:grid},ticks:{color:text}}}
        }
      });

      // MACD (still using the fixed version)
      macdChart = new Chart(document.getElementById('macdChart'), {
        type:'bar', data:{datasets:[
          {label:'MACD Histogram',data:[],backgroundColor:ctx=>(ctx.parsed?.y??0)>=0?
            'rgba(0,255,136,.8)':'rgba(255,59,92,.8)',
            borderColor:ctx=>(ctx.parsed?.y??0)>=0?
            'rgba(0,255,136,1)':'rgba(255,59,92,1)',borderWidth:1,borderRadius:2,barPercentage:.8},
          {label:'MACD Line',data:[],type:'line',borderColor:'#00aaff',
            backgroundColor:'rgba(0,170,255,.1)',borderWidth:2,pointRadius:0,fill:false},
          {label:'Signal Line',data:[],type:'line',borderColor:'#ffaa00',
            borderWidth:2,pointRadius:0,borderDash:[5,5],fill:false}
        ]},
        options:{responsive:true,maintainAspectRatio:false,
          plugins:{legend:{display:true,labels:{color:text}},
            title:{display:true,text:'MOVING AVERAGE CONVERGENCE DIVERGENCE (MACD)',
            color:text,font:{size:14,weight:'bold'}}},
          scales:{x:{type:'time',time:{unit:'minute'},grid:{color:grid},ticks:{color:text}},
                  y:{grid:{color:grid},ticks:{color:text}}}
        }
      });
    }

    // ───── EMA helper (returns array of same length as input) ─────
    function ema(series, period) {
      const k = 2/(period+1);
      const result = [];
      let emaVal = series[0].c;
      for (let i=0;i<period-1;i++) result.push(null);
      result.push(emaVal);
      for (let i=period;i<series.length;i++){
        emaVal = series[i].c*k + emaVal*(1-k);
        result.push(emaVal);
      }
      return result;
    }

    // ───── MACD (fixed) ─────
    function calculateMACD(data, fast=12, slow=26, signal=9){
      if (data.length < slow+signal) return {histogram:[],macdLine:[],signalLine:[]};
      const fastEMA = ema(data,fast);
      const slowEMA = ema(data,slow);
      const macdLine = [];
      for (let i=slow-1;i<data.length;i++){
        macdLine.push({x:data[i].x, y:fastEMA[i]-slowEMA[i]});
      }
      const k = 2/(signal+1);
      const signalLine = [{x:macdLine[0].x, y:macdLine[0].y}];
      let sig = macdLine[0].y;
      for (let i=1;i<macdLine.length;i++){
        sig = macdLine[i].y*k + sig*(1-k);
        signalLine.push({x:macdLine[i].x, y:sig});
      }
      const histogram = signalLine.map((s,i)=>({
        x:s.x, y:macdLine[i].y - s.y
      }));
      return {histogram, macdLine, signalLine};
    }

    // ───── RSI (unchanged) ─────
    function calculateRSI(data, period=14){
      if (data.length < period+1) return [];
      const gains=[], losses=[];
      for (let i=1;i<data.length;i++){
        const ch = data[i].c - data[i-1].c;
        gains.push(ch>0?ch:0);
        losses.push(ch<0?-ch:0);
      }
      let avgG = gains.slice(0,period).reduce((a,b)=>a+b,0)/period;
      let avgL = losses.slice(0,period).reduce((a,b)=>a+b,0)/period;
      const rsi = [100-(100/(1+avgG/(avgL||1)))];
      for (let i=period;i<gains.length;i++){
        avgG = (avgG*(period-1)+gains[i])/period;
        avgL = (avgL*(period-1)+losses[i])/period;
        rsi.push(100-(100/(1+avgG/(avgL||1))));
      }
      return rsi.map((v,i)=>({x:data[i+period].x, y:v}));
    }

    // ───── WebSocket ─────
    function connectBinanceWebSocket(){
      const ws = new WebSocket(`wss://stream.binance.com:9443/ws/${SYMBOL.toLowerCase()}@kline_1m`);
      ws.onopen = ()=>setStatus('LIVE • Connected to Binance','#00ff88');
      ws.onmessage = e=>{
        const k = JSON.parse(e.data).k;
        if (k.x) processNewCandle(k);
        updateLivePrice(parseFloat(k.c));
      };
      ws.onerror = ()=>setStatus('WebSocket error - reconnecting...','#ff5252');
      ws.onclose = ()=>setStatus('Reconnecting...','#ff8800');
      ws.onclose = ()=>setTimeout(connectBinanceWebSocket,3000);
      binanceSocket = ws;
    }

    function processNewCandle(k){
      const c = {x:new Date(k.t), o:+k.o, h:+k.h, l:+k.l, c:+k.c, v:+k.v};
      chartData.push(c); volumeData.push({x:new Date(k.t), y:+k.v});
      if (chartData.length>100){chartData.shift(); volumeData.shift();}
      updateCharts();
    }

    function updateCharts(){
      if (chartData.length<35) return;
      volumeChart.data.datasets[0].data = volumeData; volumeChart.update('none');
      rsiChart.data.datasets[0].data = calculateRSI(chartData); rsiChart.update('none');
      const m = calculateMACD(chartData);
      macdChart.data.datasets[0].data = m.histogram;
      macdChart.data.datasets[1].data = m.macdLine;
      macdChart.data.datasets[2].data = m.signalLine;
      macdChart.update('none');
    }

    // ───── Historical & Ticker ─────
    async function fetchHistoricalData(){
      setStatus('Loading historical data...','#ffd700');
      const r = await fetch(`https://api.binance.com/api/v3/klines?symbol=${SYMBOL}&interval=1m&limit=100`);
      const kl = await r.json();
      chartData = kl.map(k=>({x:new Date(k[0]),o:+k[1],h:+k[2],l:+k[3],c:+k[4],v:+k[5]}));
      volumeData = kl.map(k=>({x:new Date(k[0]),y:+k[5]}));
      if (chartData.length) { lastPrice = chartData.at(-1).c; updateLivePrice(lastPrice); updateCharts(); }
    }

    async function startCryptoTicker(){
      const sym = ['BTCUSDT','ETHUSDT','ADAUSDT','SOLUSDT','DOTUSDT','DOGEUSDT','XRPUSDT','LTCUSDT','LINKUSDT'];
      const upd = async ()=>{
        const r = await fetch(`https://api.binance.com/api/v3/ticker/24hr?symbols=${JSON.stringify(sym)}`);
        const d = await r.json();
        d.forEach(t=>{updateMarquee(t.symbol.replace('USDT',''),+t.lastPrice,+t.priceChangePercent);});
      };
      upd(); setInterval(upd,10000);
    }

    // ───── UI helpers ─────
    function updateLivePrice(p){
      const ch = lastPrice?((p-lastPrice)/lastPrice)*100:0;
      const el = document.getElementById('livePrice');
      el.textContent = `$${p.toFixed(2)} ${ch>=0?'+':''}${ch.toFixed(2)}%`;
      el.style.color = ch>=0?'#00ff88':'#ff5252';
      if (lastPrice && Math.abs(p-lastPrice)>0.01){
        el.style.transform='scale(1.05)'; setTimeout(()=>el.style.transform='scale(1)',200);
      }
      lastPrice = p;
    }

    function updateMarquee(sym,price,change){
      let el = document.getElementById(`m-${sym}`);
      if (!el){
        el = document.createElement('span'); el.id=`m-${sym}`;
        el.className='asset-item'; document.getElementById('tickerTape').appendChild(el);
        const c = el.cloneNode(); c.id=`m-${sym}-copy`; document.getElementById('tickerTape').appendChild(c);
      }
      const fmt = ['ADA','DOGE','XRP'].includes(sym)?4:2;
      const html = `<span class="asset-name">${sym}</span> 
                    <span class="asset-price">$${price.toFixed(fmt)}</span> 
                    <span class="asset-change" style="color:${change>=0?'#00ff88':'#ff5252'}">
                      ${change>=0?'+':''}${change.toFixed(2)}%
                    </span>`;
      el.innerHTML = html;
      const copy = document.getElementById(`m-${sym}-copy`);
      if (copy) copy.innerHTML = html;
    }

    function setStatus(txt,col){
      const el = document.getElementById('status');
      el.innerHTML = col==='#00ff88'? txt : `<span class="loading-spinner"></span>${txt}`;
      el.style.color = col;
    }

    function executeTrade(act){
      confetti({particleCount:80,spread:60,origin:{y:0.6}});
      const m = document.getElementById('tradeModal');
      document.getElementById('modalTitle').textContent = `${act.toUpperCase()} ${SYMBOL}`;
      document.getElementById('modalMessage').textContent = `Redirecting to Binance for ${act} order.`;
      const l = document.getElementById('binanceTradeLink');
      l.href = BINANCE_TRADE_URL; l.textContent = `Execute ${act} on Binance`;
      m.style.display='block';
    }

    function closeModal(){document.getElementById('tradeModal').style.display='none';}
    function connectWallet(){alert('Wallet connected to live trading system');}

    // ───── Init ─────
    window.onload = async ()=>{
      initCharts(); initTradingView(); await fetchHistoricalData();
      connectBinanceWebSocket(); startCryptoTicker();
      window.onclick = e=>{if(e.target.classList.contains('modal')) closeModal();}
    };
  </script>
</body>
</html>
