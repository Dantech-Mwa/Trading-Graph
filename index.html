<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Elite Live Crypto & NFT Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.3/dist/confetti.browser.min.js"></script>
  <style>
    :root {
      --bg: #0f0f1a;
      --card: rgba(20, 20, 40, 0.7);
      --glass: rgba(255, 255, 255, 0.05);
      --text: #e0e0ff;
      --green: #00ff88;
      --red: #ff3b5c;
      --accent: #00d4ff;
      --gold: #ffd700;
      --purple: #aa00ff;
      --orange: #ff8800;
      --shadow: 0 8px 32px rgba(0,0,0,0.4);
      --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      background: var(--bg);
      color: var(--text);
      font-family: 'Inter', 'Segoe UI', sans-serif;
      padding: 12px;
      transition: var(--transition);
      min-height: 100vh;
      background: linear-gradient(135deg, #0f0f1a 0%, #1a1a2e 100%);
    }
    .container { max-width: 1400px; margin: 0 auto; }
    .header {
      text-align: center;
      margin-bottom: 16px;
      backdrop-filter: blur(10px);
      background: var(--glass);
      border-radius: 16px;
      padding: 12px;
      border: 1px solid rgba(255,255,255,0.1);
    }
    h1 {
      font-size: clamp(1.4rem, 5vw, 2rem);
      font-weight: 800;
      background: linear-gradient(90deg, var(--green), var(--accent));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      margin-bottom: 4px;
    }
    .ticker {
      font-size: clamp(1.6rem, 6vw, 2.4rem);
      font-weight: 900;
      letter-spacing: 1px;
      text-shadow: 0 0 20px rgba(0,212,170,0.5);
      animation: pulse 2s infinite;
    }
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.8; }
    }
    .status {
      font-size: 0.9rem;
      color: var(--accent);
      font-weight: 500;
    }
    .trading-buttons {
      display: flex; justify-content: center; gap: 12px; margin: 12px 0;
    }
    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 12px;
      font-weight: bold;
      cursor: pointer;
      transition: var(--transition);
      box-shadow: var(--shadow);
    }
    .btn-buy { background: var(--green); color: white; }
    .btn-sell { background: var(--red); color: white; }
    .btn:hover { transform: scale(1.05); box-shadow: 0 0 20px currentColor; }
    .chart-box {
      background: var(--card);
      border-radius: 20px;
      padding: 16px;
      margin-bottom: 16px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(12px);
      border: 1px solid rgba(255,255,255,0.1);
      position: relative;
      overflow: hidden;
    }
    .chart-box::before {
      content: '';
      position: absolute;
      top: 0; left: 0; right: 0;
      height: 3px;
      background: linear-gradient(90deg, var(--green), var(--accent), var(--purple));
    }
    #tradingview-chart { width: 100%; height: 400px; border-radius: 12px; }
    .marquee {
      background: var(--glass);
      padding: 12px;
      border-radius: 16px;
      overflow: hidden;
      white-space: nowrap;
      font-size: 0.95rem;
      margin: 16px 0;
      border: 1px solid rgba(255,255,255,0.1);
    }
    .marquee-content {
      display: inline-block;
      animation: scroll 30s linear infinite;
    }
    @keyframes scroll {
      0% { transform: translateX(0); }
      100% { transform: translateX(-50%); }
    }
    .asset-item {
      display: inline-block;
      margin-right: 32px;
      font-weight: 600;
    }
    .asset-name { color: var(--gold); }
    .asset-price { color: var(--text); }
    .asset-change { font-size: 0.8rem; }
    .nft-item { color: var(--purple); }
    .wallet-btn {
      position: fixed; top: 20px; right: 20px;
      padding: 8px 16px;
      background: var(--accent);
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: var(--transition);
    }
    .wallet-btn:hover { background: var(--purple); }
    .modal {
      display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.5); backdrop-filter: blur(5px);
    }
    .modal-content { 
      background: var(--card); 
      margin: 15% auto; 
      padding: 30px; 
      border-radius: 16px; 
      width: 80%; 
      max-width: 450px; 
      text-align: center; 
      box-shadow: var(--shadow);
    }
    .close { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
    .close:hover { color: var(--text); }
    .footer {
      text-align: center;
      margin: 24px 0 12px;
      font-size: 0.8rem;
      color: #888;
      font-style: italic;
    }
    .loading-spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255,255,255,.3);
      border-radius: 50%;
      border-top-color: var(--accent);
      animation: spin 1s ease-in-out infinite;
      margin-right: 10px;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    .binance-link {
      display: inline-block;
      margin-top: 15px;
      padding: 12px 24px;
      background: var(--accent);
      color: white;
      text-decoration: none;
      border-radius: 8px;
      font-weight: bold;
      transition: var(--transition);
    }
    .binance-link:hover {
      background: var(--orange);
      transform: translateY(-2px);
    }
    .chart-container {
      height: 300px;
      position: relative;
    }
    @media (max-width: 768px) {
      .chart-box { padding: 12px; margin-bottom: 12px; }
      #tradingview-chart { height: 300px; }
      .trading-buttons { flex-direction: column; align-items: center; }
      .marquee { font-size: 0.85rem; }
      .asset-item { margin-right: 20px; }
    }
  </style>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800;900&display=swap" rel="stylesheet">
</head>
<body>
  <button class="wallet-btn" onclick="connectWallet()">Connect Wallet</button>

  <div class="container">
    <div class="header">
      <h1>Elite Live Crypto & NFT Dashboard</h1>
      <div class="ticker" id="livePrice">Loading...</div>
      <div class="status" id="status">
        <span class="loading-spinner"></span>Connecting to Binance WebSocket...
      </div>
      <div class="trading-buttons">
        <button class="btn btn-buy" onclick="executeTrade('buy')">Buy BNB</button>
        <button class="btn btn-sell" onclick="executeTrade('sell')">Sell BNB</button>
      </div>
    </div>

    <div class="chart-box">
      <div id="tradingview-chart"></div>
    </div>

    <div class="chart-box">
      <div class="chart-container">
        <canvas id="volumeChart"></canvas>
      </div>
    </div>

    <div class="chart-box">
      <div class="chart-container">
        <canvas id="rsiChart"></canvas>
      </div>
    </div>

    <div class="chart-box">
      <div class="chart-container">
        <canvas id="macdChart"></canvas>
      </div>
    </div>

    <div class="marquee">
      <div class="marquee-content" id="tickerTape"></div>
    </div>

    <div class="footer">
      Live Binance WebSocket Data • Real-time Trading • Professional Indicators
    </div>
  </div>

  <div id="tradeModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeModal()">×</span>
      <h2 id="modalTitle">Trade Redirect</h2>
      <p id="modalMessage">You are being redirected to Binance to execute your trade.</p>
      <a id="binanceTradeLink" class="binance-link" href="#" target="_blank">
        Continue to Binance
      </a>
    </div>
  </div>

  <script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>
  <script>
  // ──────────────────────────────────────────────────────────────
  // LIVE BINANCE WEBSOCKET CONNECTION
  // ──────────────────────────────────────────────────────────────
  const SYMBOL = 'BNBUSDT';
  const BINANCE_TRADE_URL = `https://www.binance.com/en/trade/${SYMBOL}`;
  let binanceSocket = null;
  let chartData = [];
  let volumeData = [];
  let lastPrice = 0;
  let volumeChart, rsiChart, macdChart;

  // Initialize TradingView Chart
  function initTradingView() {
    new TradingView.widget({
      "width": "100%",
      "height": "400",
      "symbol": `BINANCE:${SYMBOL}`,
      "interval": "1",
      "timezone": "Etc/UTC",
      "theme": "dark",
      "style": "1",
      "locale": "en",
      "toolbar_bg": "#f1f3f6",
      "enable_publishing": false,
      "hide_side_toolbar": false,
      "allow_symbol_change": true,
      "container_id": "tradingview-chart",
      "studies": ["Volume@tv-basicstudies", "RSI@tv-basicstudies", "MACD@tv-basicstudies"]
    });
  }

  // Initialize Chart.js Charts
  function initCharts() {
    const gridColor = 'rgba(255,255,255,0.1)';
    const textColor = '#e0e0ff';

    // Volume Chart
    volumeChart = new Chart(document.getElementById('volumeChart'), {
      type: 'bar',
      data: { 
        datasets: [{
          label: 'Volume',
          data: [],
          backgroundColor: (ctx) => {
            const index = ctx.dataIndex;
            if (index > 0 && chartData[index] && chartData[index-1]) {
              return chartData[index].c >= chartData[index-1].c ? 
                'rgba(0, 255, 136, 0.7)' : 'rgba(255, 59, 92, 0.7)';
            }
            return 'rgba(0, 212, 255, 0.7)';
          },
          borderColor: 'rgba(255,255,255,0.3)',
          borderWidth: 1,
          borderRadius: 2
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false },
          title: { 
            display: true, 
            text: 'TRADING VOLUME',
            color: textColor,
            font: { size: 14, weight: 'bold' }
          }
        },
        scales: {
          x: {
            type: 'time',
            time: { unit: 'minute' },
            grid: { color: gridColor },
            ticks: { color: textColor }
          },
          y: {
            beginAtZero: true,
            grid: { color: gridColor },
            ticks: { color: textColor },
            title: {
              display: true,
              text: 'Volume',
              color: textColor
            }
          }
        }
      }
    });

    // RSI Chart
    rsiChart = new Chart(document.getElementById('rsiChart'), {
      type: 'line',
      data: { 
        datasets: [{
          label: 'RSI',
          data: [],
          borderColor: '#aa00ff',
          backgroundColor: 'rgba(170, 0, 255, 0.1)',
          fill: true,
          tension: 0.4,
          pointRadius: 0,
          borderWidth: 2
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false },
          title: { 
            display: true, 
            text: 'RELATIVE STRENGTH INDEX (RSI)',
            color: textColor,
            font: { size: 14, weight: 'bold' }
          }
        },
        scales: {
          x: {
            type: 'time',
            time: { unit: 'minute' },
            grid: { color: gridColor },
            ticks: { color: textColor }
          },
          y: {
            min: 0,
            max: 100,
            grid: { color: gridColor },
            ticks: { color: textColor }
          }
        }
      }
    });

    // MACD Chart – only the data objects are empty; they will be filled later
    macdChart = new Chart(document.getElementById('macdChart'), {
      type: 'bar',
      data: { 
        datasets: [
          {
            label: 'MACD Histogram',
            data: [],
            backgroundColor: ctx => (ctx.parsed?.y ?? 0) >= 0 ? 'rgba(0, 255, 136, 0.8)' : 'rgba(255, 59, 92, 0.8)',
            borderColor: ctx => (ctx.parsed?.y ?? 0) >= 0 ? 'rgba(0, 255, 136, 1)' : 'rgba(255, 59, 92, 1)',
            borderWidth: 1,
            borderRadius: 2,
            barPercentage: 0.8
          },
          {
            label: 'MACD Line',
            data: [],
            type: 'line',
            borderColor: '#00aaff',
            backgroundColor: 'rgba(0, 170, 255, 0.1)',
            borderWidth: 2,
            pointRadius: 0,
            fill: false
          },
          {
            label: 'Signal Line',
            data: [],
            type: 'line',
            borderColor: '#ffaa00',
            borderWidth: 2,
            pointRadius: 0,
            borderDash: [5, 5],
            fill: false
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { 
            display: true,
            labels: { color: textColor }
          },
          title: { 
            display: true, 
            text: 'MOVING AVERAGE CONVERGENCE DIVERGENCE (MACD)',
            color: textColor,
            font: { size: 14, weight: 'bold' }
          }
        },
        scales: {
          x: {
            type: 'time',
            time: { unit: 'minute' },
            grid: { color: gridColor },
            ticks: { color: textColor }
          },
          y: {
            grid: { color: gridColor },
            ticks: { color: textColor }
          }
        }
      }
    });
  }

  // ──────────────────────────────────────────────────────────────
  // EMA HELPERS (return array starting at period-1)
  // ──────────────────────────────────────────────────────────────
  function ema(series, period) {
    const k = 2 / (period + 1);
    const result = [];
    let emaVal = series[0].c;

    // first value is SMA of the first `period` points
    for (let i = 0; i < period - 1; i++) result.push(null);
    result.push(emaVal);

    for (let i = period; i < series.length; i++) {
      emaVal = series[i].c * k + emaVal * (1 - k);
      result.push(emaVal);
    }
    return result;   // length === series.length, first `period-1` entries are null
  }

  // ──────────────────────────────────────────────────────────────
  // MACD CALCULATION – FIXED
  // ──────────────────────────────────────────────────────────────
  function calculateMACD(data, fast = 12, slow = 26, signal = 9) {
    if (data.length < slow + signal) {
      return { histogram: [], macdLine: [], signalLine: [] };
    }

    const fastEMA = ema(data, fast);
    const slowEMA = ema(data, slow);

    // MACD line = fastEMA - slowEMA (starts at index `slow-1`)
    const macdLine = [];
    for (let i = slow - 1; i < data.length; i++) {
      const val = fastEMA[i] - slowEMA[i];
      macdLine.push({ x: data[i].x, y: val });
    }

    // Signal line = EMA of MACD line
    const signalLine = [];
    const k = 2 / (signal + 1);
    let sig = macdLine[0].y;
    signalLine.push({ x: macdLine[0].x, y: sig });

    for (let i = 1; i < macdLine.length; i++) {
      sig = macdLine[i].y * k + sig * (1 - k);
      signalLine.push({ x: macdLine[i].x, y: sig });
    }

    // Histogram = MACD - Signal (same length as signalLine)
    const histogram = signalLine.map((s, idx) => ({
      x: s.x,
      y: macdLine[idx].y - s.y
    }));

    return { histogram, macdLine, signalLine };
  }

  // ──────────────────────────────────────────────────────────────
  // RSI (unchanged)
  // ──────────────────────────────────────────────────────────────
  function calculateRSI(data, period = 14) {
    if (data.length < period + 1) return [];
    
    const gains = [];
    const losses = [];
    
    for (let i = 1; i < data.length; i++) {
      const change = data[i].c - data[i-1].c;
      gains.push(change > 0 ? change : 0);
      losses.push(change < 0 ? -change : 0);
    }
    
    let avgGain = gains.slice(0, period).reduce((a, b) => a + b, 0) / period;
    let avgLoss = losses.slice(0, period).reduce((a, b) => a + b, 0) / period;
    
    const rsi = [100 - (100 / (1 + avgGain / (avgLoss || 1)))];
    
    for (let i = period; i < gains.length; i++) {
      avgGain = (avgGain * (period - 1) + gains[i]) / period;
      avgLoss = (avgLoss * (period - 1) + losses[i]) / period;
      rsi.push(100 - (100 / (1 + avgGain / (avgLoss || 1))));
    }
    
    return rsi.map((value, index) => ({
      x: data[index + period].x,
      y: value
    }));
  }

  // ──────────────────────────────────────────────────────────────
  // WEBSOCKET & DATA PROCESSING
  // ──────────────────────────────────────────────────────────────
  function connectBinanceWebSocket() {
    const ws = new WebSocket(`wss://stream.binance.com:9443/ws/${SYMBOL.toLowerCase()}@kline_1m`);
    
    ws.onopen = () => {
      setStatus('LIVE • Connected to Binance', '#00ff88');
    };

    ws.onmessage = (event) => {
      const data = JSON.parse(event.data);
      const kline = data.k;
      
      if (kline.x) { // closed candle
        processNewCandle(kline);
      }
      
      updateLivePrice(parseFloat(kline.c));
    };

    ws.onerror = (error) => {
      console.error('WebSocket error:', error);
      setStatus('WebSocket error - reconnecting...', '#ff5252');
      setTimeout(connectBinanceWebSocket, 5000);
    };

    ws.onclose = () => {
      setStatus('Reconnecting to Binance...', '#ff8800');
      setTimeout(connectBinanceWebSocket, 3000);
    };

    binanceSocket = ws;
  }

  function processNewCandle(kline) {
    const newCandle = {
      x: new Date(kline.t),
      o: parseFloat(kline.o),
      h: parseFloat(kline.h),
      l: parseFloat(kline.l),
      c: parseFloat(kline.c),
      v: parseFloat(kline.v)
    };

    chartData.push(newCandle);
    volumeData.push({ x: new Date(kline.t), y: parseFloat(kline.v) });

    if (chartData.length > 100) {
      chartData.shift();
      volumeData.shift();
    }

    updateCharts();
  }

  function updateCharts() {
    if (chartData.length < 35) return;

    // Volume
    volumeChart.data.datasets[0].data = volumeData;
    volumeChart.update('none');

    // RSI
    const rsiValues = calculateRSI(chartData);
    rsiChart.data.datasets[0].data = rsiValues;
    rsiChart.update('none');

    // MACD – FIXED
    const macd = calculateMACD(chartData);
    macdChart.data.datasets[0].data = macd.histogram;
    macdChart.data.datasets[1].data = macd.macdLine;
    macdChart.data.datasets[2].data = macd.signalLine;
    macdChart.update('none');
  }

  // ──────────────────────────────────────────────────────────────
  // HISTORICAL DATA & TICKER
  // ──────────────────────────────────────────────────────────────
  async function fetchHistoricalData() {
    try {
      setStatus('Loading historical data...', '#ffd700');
      const response = await fetch(`https://api.binance.com/api/v3/klines?symbol=${SYMBOL}&interval=1m&limit=100`);
      const klines = await response.json();
      
      chartData = klines.map(k => ({
        x: new Date(k[0]),
        o: parseFloat(k[1]),
        h: parseFloat(k[2]),
        l: parseFloat(k[3]),
        c: parseFloat(k[4]),
        v: parseFloat(k[5])
      }));
      
      volumeData = klines.map(k => ({
        x: new Date(k[0]),
        y: parseFloat(k[5])
      }));
      
      if (chartData.length > 0) {
        lastPrice = chartData[chartData.length - 1].c;
        updateLivePrice(lastPrice);
        updateCharts();
      }
    } catch (e) { console.error(e); }
  }

  async function startCryptoTicker() {
    const symbols = ['BTCUSDT','ETHUSDT','ADAUSDT','SOLUSDT','DOTUSDT','DOGEUSDT','XRPUSDT','LTCUSDT','LINKUSDT'];
    const update = async () => {
      try {
        const resp = await fetch(`https://api.binance.com/api/v3/ticker/24hr?symbols=${JSON.stringify(symbols)}`);
        const data = await resp.json();
        data.forEach(t => {
          const s = t.symbol.replace('USDT','');
          const p = parseFloat(t.lastPrice);
          const ch = parseFloat(t.priceChangePercent);
          updateMarquee(s, p, ch);
        });
      } catch (e) { console.error(e); }
    };
    update();
    setInterval(update, 10000);
  }

  // ──────────────────────────────────────────────────────────────
  // UI HELPERS
  // ──────────────────────────────────────────────────────────────
  function updateLivePrice(price) {
    const change = lastPrice ? ((price - lastPrice) / lastPrice) * 100 : 0;
    const el = document.getElementById('livePrice');
    el.textContent = `$${price.toFixed(2)} ${change>=0?'+':''}${change.toFixed(2)}%`;
    el.style.color = change >= 0 ? '#00ff88' : '#ff5252';
    if (lastPrice && Math.abs(price - lastPrice) > 0.01) {
      el.style.transform = 'scale(1.05)';
      setTimeout(() => el.style.transform = 'scale(1)', 200);
    }
    lastPrice = price;
  }

  function updateMarquee(symbol, price, change, isNFT = false) {
    let el = document.getElementById(`m-${symbol}`);
    if (!el) {
      el = document.createElement('span');
      el.id = `m-${symbol}`;
      el.className = `asset-item ${isNFT ? 'nft-item' : ''}`;
      document.getElementById('tickerTape').appendChild(el);
      const copy = el.cloneNode(true);
      copy.id = `m-${symbol}-copy`;
      document.getElementById('tickerTape').appendChild(copy);
    }
    const fmt = ['ADA','DOGE','XRP'].includes(symbol) ? 4 : 2;
    const html = `<span class="asset-name">${symbol}</span> 
                  <span class="asset-price">$${price.toFixed(fmt)}</span> 
                  <span class="asset-change" style="color:${change>=0?'#00ff88':'#ff5252'}">
                    ${change>=0?'+':''}${change.toFixed(2)}%
                  </span>`;
    el.innerHTML = html;
    const copy = document.getElementById(`m-${symbol}-copy`);
    if (copy) copy.innerHTML = html;
  }

  function setStatus(text, color) {
    const el = document.getElementById('status');
    el.innerHTML = color === '#00ff88' ? text : `<span class="loading-spinner"></span>${text}`;
    el.style.color = color;
  }

  function executeTrade(action) {
    confetti({ particleCount: 80, spread: 60, origin: { y: 0.6 } });
    const modal = document.getElementById('tradeModal');
    document.getElementById('modalTitle').textContent = `${action.toUpperCase()} ${SYMBOL}`;
    document.getElementById('modalMessage').textContent = `You are being redirected to Binance to execute your ${action} order.`;
    const link = document.getElementById('binanceTradeLink');
    link.href = BINANCE_TRADE_URL;
    link.textContent = `Execute ${action} on Binance`;
    modal.style.display = 'block';
  }

  function closeModal() { document.getElementById('tradeModal').style.display = 'none'; }
  function connectWallet() { alert('Wallet connected to live trading system'); }

  // ──────────────────────────────────────────────────────────────
  // INITIALISATION
  // ──────────────────────────────────────────────────────────────
  window.onload = async () => {
    initCharts();
    initTradingView();
    await fetchHistoricalData();
    connectBinanceWebSocket();
    startCryptoTicker();

    window.onclick = e => { if (e.target.classList.contains('modal')) closeModal(); };
  };
  </script>
</body>
</html>
